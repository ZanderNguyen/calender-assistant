<!DOCTYPE html>
<html>

<head>
  <title>Calendar Assistant</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>

<body>
  <button id="theme-toggle" style="position:fixed;top:24px;right:32px;z-index:200;padding:8px 16px;border-radius:8px;border:none;background:#23262f;color:#fff;cursor:pointer;">
    üåô Dark
  </button>
  <form action="/clear" method="POST" class="clear-history-top" style="position:fixed;top:24px;right:140px;z-index:200;">
    <button type="submit">üßπ Clear History</button>
  </form>
  <div class="page">
    {% if not history %}
    <div class="welcome-container" id="welcome">
      <h1>üß† Calendar Assistant</h1>
      <p>How can I help you today?</p>
      <form action="/action" method="POST" class="prompt-form chat-input" id="welcome-form">
        <input type="text" name="prompt" placeholder="Type your request..." required autocomplete="off">
        <button type="submit">Send</button>
      </form>
      <div class="auth-link">
        <a href="/authorize">üîê Sign in with Google</a>
      </div>
    </div>
    {% endif %}

    <div class="header" {% if not history %}style="display:none;" {% endif %}>
      <h1>üß† Calendar Assistant</h1>
      <p class="subtitle">Here‚Äôs what we‚Äôve done so far:</p>
    </div>

    <div class="chat-window{% if not history %} hidden{% endif %}">
      {% if history %}
      {% for item in history %}
      {% set parts = item.split('<br>', 1) %}
      <div class="chat user">
        <div class="bubble user-bubble">{{ parts[0]|safe }}</div>
      </div>
      <div class="chat assistant">
        <div class="bubble assistant-bubble">{{ parts[1]|safe }}</div>
      </div>
      {% endfor %}
      {% endif %}
    </div>

  <form action="/action" method="POST" class="fixed-input chat-input{% if not history %} hidden{% endif %}">
    <textarea name="prompt" placeholder="Type your request..." required autocomplete="off" rows="1"></textarea>
    <button type="submit">Send</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatWindow = document.querySelector('.chat-window');
      const header = document.querySelector('.header');
      const actions = document.querySelector('.actions');
      const welcome = document.getElementById('welcome');
      const fixedForm = document.querySelector('form.fixed-input');
      const fixedInput = fixedForm ? fixedForm.querySelector('input[name="prompt"]') : null;

      const escapeHtml = (text) => text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const revealChat = () => {
        if (header) {
          header.style.removeProperty('display');
        }
        if (actions) {
          actions.style.removeProperty('display');
        }
        if (chatWindow) {
          chatWindow.classList.remove('hidden');
        }
        if (fixedForm) {
          fixedForm.classList.remove('hidden');
          fixedForm.style.display = 'flex';
        }
        if (welcome) {
          welcome.style.display = 'none';
        }
      };

      const appendUserBubble = (html) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'chat user';
        const bubble = document.createElement('div');
        bubble.className = 'bubble user-bubble';
        bubble.innerHTML = html;
        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        return bubble;
      };

      const appendAssistantPlaceholder = () => {
        const wrapper = document.createElement('div');
        wrapper.className = 'chat assistant';
        const bubble = document.createElement('div');
        bubble.className = 'bubble assistant-bubble typing';
        bubble.innerHTML = '<span></span><span></span><span></span>';
        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        return bubble;
      };

      const handleSubmit = async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const data = new FormData(form);
        const prompt = (data.get('prompt') || '').trim();

        if (!prompt) {
          return;
        }

        revealChat();

        if (form !== fixedForm && fixedForm) {
          fixedForm.reset();
        }
        form.reset();

        const userBubble = appendUserBubble(`<strong>${escapeHtml(prompt)}</strong>`);
        const assistantBubble = appendAssistantPlaceholder();
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: data
          });
          const payload = await res.json();

          if (!res.ok || (payload && payload.error)) {
            const errorMessage = payload && payload.error ? payload.error : 'Something went wrong.';
            throw new Error(errorMessage);
          }

          if (payload && payload.prompt_html) {
            userBubble.innerHTML = payload.prompt_html;
          }

          assistantBubble.classList.remove('typing');
          assistantBubble.innerHTML = (payload && payload.response_html) ? payload.response_html : '<p>Done.</p>';
        } catch (err) {
          assistantBubble.classList.remove('typing');
          assistantBubble.innerHTML = `<p>‚ö†Ô∏è ${escapeHtml(err.message)}</p>`;
        } finally {
          chatWindow.scrollTop = chatWindow.scrollHeight;
          if (fixedInput) {
            fixedInput.focus();
          }
        }
      };

      document.querySelectorAll('form.chat-input').forEach((form) => {
        form.addEventListener('submit', handleSubmit);
      });

      document.querySelectorAll('form.chat-input textarea').forEach((ta) => {
        ta.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
      });

      if (chatWindow) {
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
      if (fixedInput) {
        fixedInput.focus();
      }
    });

    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    let darkMode = false;

    function setTheme(dark) {
      darkMode = dark;
      if (dark) {
        body.classList.add('dark');
        themeToggle.textContent = '‚òÄÔ∏è Light';
        themeToggle.style.background = '#f5f5f5';
        themeToggle.style.color = '#23262f';
      } else {
        body.classList.remove('dark');
        themeToggle.textContent = 'üåô Dark';
        themeToggle.style.background = '#23262f';
        themeToggle.style.color = '#fff';
      }
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }

    themeToggle.addEventListener('click', () => setTheme(!darkMode));

    // On load, set theme from localStorage
    setTheme(localStorage.getItem('theme') === 'dark');
  </script>
</body>

</html>